pipeline {
    agent any
environment {
    DOCKERHUB_CREDENTIALS = credentials('dockerhub')
     registry = "prathibhagond/backend-java"
     registryCredential = 'dockeruser'
     dockerImage = ''
}
stages {
 stage('creating the database container') {
        steps {
            sh 'docker container rm --force lmsdb'
            sh 'docker run -d -p 3307:3306 --network lms-network -e MYSQL_ROOT_PASSWORD=Mysql@123 --name lmsdb mysql'
        }
    }
    stage('building the docker image') {
        steps {
            sh 'cd LMS-BE && docker build -t prathibhagond/backend-java .'
        }
    }
    stage('dockerhub login') {
        steps {
            sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
        }
    }
    stage('pushing the docker image to dockerhub') {
        steps {
            sh 'docker push prathibhagond/backend-java'
        }
    }
    stage('remove old docker image') {
        steps {
            sh 'docker rmi -f prathibhagond/backend-java'
        }
    }
   
    stage('creating the docker container-backend') {
        steps {
            sh 'docker container rm --force prathibhagond/backend-java'
            sh 'docker container run -d -p 8080:8080 --network lmsnetwork -e DATABASE_URL=mysql://root:Mysql@123@lmsdb:3306/mysql --name backend-lms -e PORT=8080 -e MODE=local prathibhagond/backend-java'
        }
    }
  }
}
